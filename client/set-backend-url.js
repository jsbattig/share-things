#!/usr/bin/env node

/**
 * This script sets the BACKEND_URL environment variable based on the machine's IP address
 * It's used to configure the Vite dev server proxy and the frontend's API URL
 */

import { networkInterfaces } from 'os';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Get the directory name
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Get the machine's IP address
function getLocalIpAddress() {
  const nets = networkInterfaces();
  const results = {};

  for (const name of Object.keys(nets)) {
    for (const net of nets[name]) {
      // Skip over non-IPv4 and internal (i.e. 127.0.0.1) addresses
      if (net.family === 'IPv4' && !net.internal) {
        if (!results[name]) {
          results[name] = [];
        }
        results[name].push(net.address);
      }
    }
  }

  // Prefer en0 or eth0 interfaces
  for (const name of ['en0', 'eth0', 'Ethernet', 'Wi-Fi']) {
    if (results[name] && results[name].length > 0) {
      return results[name][0];
    }
  }

  // Otherwise, return the first available IP
  for (const addresses of Object.values(results)) {
    if (addresses.length > 0) {
      return addresses[0];
    }
  }

  // Fallback to localhost
  return 'localhost';
}

// Get the IP address
const ipAddress = getLocalIpAddress();
console.log(`Machine IP address: ${ipAddress}`);

// Get the API port from environment variable or use default
const apiPort = process.env.API_PORT || '3001';
console.log(`Using API port: ${apiPort}`);

// Create .env file with the correct configuration
const envContent = `# API Configuration
# Automatically generated by set-backend-url.js
VITE_API_URL=auto
VITE_SOCKET_URL=auto
VITE_API_PORT=${apiPort}

# Feature Flags
VITE_ENABLE_ANALYTICS=false
VITE_ENABLE_LOGGING=false

# Content Configuration
VITE_MAX_FILE_SIZE=104857600  # 100MB in bytes
VITE_DEFAULT_CHUNK_SIZE=65536  # 64KB in bytes
`;

// Write to .env file
fs.writeFileSync(path.join(__dirname, '.env'), envContent);
console.log(`Created .env file with API port: ${apiPort}`);

// Export the backend URL for use in npm scripts
process.env.BACKEND_URL = `http://${ipAddress}:${apiPort}`;
console.log(`Set BACKEND_URL environment variable to: http://${ipAddress}:${apiPort}`);

// Create a .env.backend file for the Vite config to use
const backendEnvContent = `BACKEND_URL=http://${ipAddress}:${apiPort}`;
fs.writeFileSync(path.join(__dirname, '.env.backend'), backendEnvContent);
console.log(`Created .env.backend file with BACKEND_URL: http://${ipAddress}:${apiPort}`);

// Exit with success
process.exit(0);